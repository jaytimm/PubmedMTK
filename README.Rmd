---
output:
  md_document:
    variant: markdown_github
---

```{r eval=FALSE, include=FALSE}
# <!-- badges: start -->
# [![Travis build status](https://travis-ci.com/jaytimm/PubmedMTK.svg?branch=main)](https://travis-ci.com/jaytimm/PubmedMTK)
# <!-- badges: end -->
```


# PubmedMTK

***PubMed Mining Toolkit***

An R package for querying the PubMed database & parsing retrieved records.  Toolkit facilitates batch API requests, the creation of custom corpora for NLP, and the quick exploration & visualization of topic structure.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("resources/render_toc.R")
```


```{r echo=FALSE}
render_toc("README.Rmd",
           toc_header_name = "PubmedMTK",
           toc_depth = 2)
```



## Installation

```{r eval=FALSE}
devtools::install_github("jaytimm/PubmedMTK")
```


## Usage

```{r message=FALSE, warning=FALSE, include=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(text2vec, ggplot2, knitr, magrittr, dplyr, tidyr)
```


### PubMed search

The `pmtk_search_pubmed()` function is meant for record-matching searches typically performed using the [PubMed online interface](https://pubmed.ncbi.nlm.nih.gov/).  The `search_term` parameter specifies the query term; the `fields` parameter can be used to specify which fields to query. 

```{r}
s0 <- PubmedMTK::pmtk_search_pubmed(search_term = 'medical marijuana', 
                                    fields = c('TIAB','MH'))
```
```{r}
head(s0)
```




### Retrieve abstract data from PubMed

```{r message=FALSE, warning=FALSE, include=FALSE}
# Set NCBI API key
key <- '4f47f85a9cc03c4031b3dc274c2840b06108'
#rentrez::set_entrez_key(key)
```



```{r warning=FALSE}
sen_df <- PubmedMTK::pmtk_get_records2(pmids = s0$pmid, 
                                       cores = 6, 
                                       ncbi_key = key) 
```


> Sample record from output:

```{r}
sen_df <- data.table::rbindlist(sen_df)

n <- 9
list(pmid = sen_df$pmid[n],
     year = sen_df$year[n],
     articletitle = strwrap(sen_df$articletitle[n], width = 60),
     meshHeadings = strwrap(sen_df$meshHeadings[n], width = 60),
     text = strwrap(sen_df$abstract[n], width = 60)[1:10])
```



### Extract MeSH classifications

Subject terms/headings in metadata table include `MeSH` terms, as well as (some) `keywords` & `chem-names`.   The `pmtk_gather_mesh` function extracts & structures these attributes from metadata. The resulting table amounts to a document-term matrix (DTM), in which each PubMed abstract is represented as a vector of MeSH terms.  

```{r message=FALSE, warning=FALSE}
m0 <- PubmedMTK::pmtk_gather_mesh(sen_df)
```




### MeSH annotations-based topic model

We can use these MeSH-based abstract representations to explore the conceptual structure of a particular collection of PubMed records via topic modeling. Here we implement **Latent Dirichlet allocation**, which is a topic modeling algorithm that models *each document* in corpus as a composite of topics, and *each topic* as a composite of terms.  Topic composition can be interpreted as sets of MeSH terms that frequently co-occur.


```{r eval=FALSE, include=FALSE}
mesh <- PubmedMTK::pmtk_tbl_mesh
mesh$under <- gsub(' ', '_', mesh$TermName)
junk <- subset(mesh, cats %in% c('Named Groups', 'Geographicals') |
                  mesh2 %in% 'Animals')
```


```{r message=FALSE, warning=FALSE}
as.text <- m0[, list(text = paste(term, collapse = " ")), by = pmid]
iter <- text2vec::itoken(as.text$text, ids = as.text$pmid)  
vocab <- text2vec::create_vocabulary(iter)

vocab0 <- text2vec::prune_vocabulary(
  vocab, 
  # doc_proportion_min = 0.0001,
  doc_proportion_max = 0.55,
  doc_count_min = 3) 

vectorizer <- text2vec::vocab_vectorizer(vocab0)
dtm <- text2vec::create_dtm(iter, vectorizer)
```



The `pmtk_summarize_lda` function summarizes and extracts topic composition from the `text2vec::LDA` output. For each possible topic-feature pair, the model computes the likelihood a given topic generated a given feature.  Output is filtered to the highest scoring features per topic using the `topic_feats_n`.

```{r message=FALSE, warning=FALSE}
lda <- text2vec::LDA$new(n_topics = 20) 
fit <- lda$fit_transform(dtm, progressbar = F)

tm_summary <- PubmedMTK::pmtk_summarize_lda(
  lda = lda, topic_feats_n = 10)
```


#### Feature composition of first ten topics

```{r echo=FALSE}
tm_summary$topic_summary %>% slice(1:10) %>% knitr::kable()
```


### Two-dimensional analyses

```{r}
tmat <- tidytext::cast_sparse(data = tm_summary$topic_word_dist,
                              row = topic_id,
                              column = feature,
                              value = beta)

## build 2d data structures --
two_ds <- PubmedMTK::pmtk_2d(mat = tmat)
```


#### Hierarchical clustering

```{r}
#two_ds$hc$labels <- tm_summary$topic_summary$topic_features
two_ds$hc %>% ggdendro::ggdendrogram(rotate=TRUE)
```


#### tSNE

```{r}
two_ds$tsne %>%
  ggplot(aes(x = X1,
             y = X2,
             label = topic_id)) +
  ggplot2::geom_point(size = 10, 
                      color = '#a5c8e1',
                      alpha = 0.5) +
  geom_text(size = 3) +
  ggtitle('Topics in 2d space')
```


```{r eval=FALSE, include=FALSE}
#### Visualize topic model
if (!require("pacman")) install.packages("pacman")
pacman::p_load(LDAvis)

mesh_lda$plot()
mesh_lda$plot(out.dir = "ldavis", open.browser = FALSE)

serVis(json, out.dir = 'ldavis', open.browser = FALSE)
```


## Interactive HTML topic summary

```{r eval=FALSE}
PubmedMTK::pmtk_build_interactive(pmtk_lda = tm_summary,
                                  pmtk_2d = two_ds,
                                  out_dir = '/home/jtimm/Desktop/',
                                  file_name = 'party.html')
```


```{r pressure, echo=FALSE, fig.cap="A caption", out.width = '100%'}
knitr::include_graphics("/home/jtimm/jt_work/GitHub/packages/PubmedMTK/demo.png")
```




## Tables

### MeSH vocabulary 

  The package includes as a data frame the MeSH thesaurus & hierarchically-organized vocabulary -- comprised of 2021 versions of `descriptor` & `trees` files made available via NLM-NIH.  [A workflow](https://github.com/jaytimm/PubmedMTK/blob/main/mds/build-MeSH-df.md) for re-creating the table from raw data sets.  

```{r}
PubmedMTK::pmtk_tbl_mesh[1:5, c(1:3, 5:6)]
```




### PMC MeSH annotation frequencies

MeSH annotation frequencies for the Open Access Common Use portion of PMC.  Frequencies based on roughly 1.8 million PubMed records.  Details [here](https://github.com/jaytimm/PubmedMTK/blob/main/mds/pmc-reference.md).

```{r}
PubmedMTK::pmtk_tbl_pmc_ref
```





### Medline citation counts

Table build details available [here](https://github.com/jaytimm/PubmedMTK/blob/main/mds/medline_citations.md).

```{r}
tail(PubmedMTK::pmtk_tbl_citations)
```

